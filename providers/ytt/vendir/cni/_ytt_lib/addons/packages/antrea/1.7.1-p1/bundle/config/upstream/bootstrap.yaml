# NOTE: This yaml is only for development and testing convenience.
# In production, boostrap-config.yaml should be used. NSX PI and VHC
# should be created by NSX-T admin. Fill in the PI cert and VHC path to
# bootstrap-config.yaml.
---
apiVersion: v1
kind: Namespace
metadata:
  name: vmware-system-antrea
  labels:
    app: antrea-interworking
    openshift.io/run-level: '0'
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: antrea-interworking
  name: bootstrap
  namespace: vmware-system-antrea
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: antrea-interworking
  name: bootstrap
  namespace: vmware-system-antrea
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
      - secrets
    verbs:
      - get
      - list
      - create
      - update
      - patch
      - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: antrea-interworking
  name: bootstrap
  namespace: vmware-system-antrea
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: bootstrap
subjects:
  - kind: ServiceAccount
    name: bootstrap
---
apiVersion: v1
kind: Secret
metadata:
  name: nsxsecret
  namespace: vmware-system-antrea
type: Opaque
data:
  # NOTE: change to actual NSX admin credential (base64 encoded in one line)
  # echo -n 'dummyAdmin' | base64
  nsxUser: ZHVtbXlBZG1pbg==
  # echo -n 'dummyPassword' | base64
  nsxPassword: ZHVtbXlQYXNzd29yZA==
---
apiVersion: batch/v1
kind: Job
metadata:
  name: bootstrap
  labels:
    app: antrea-interworking
    component: bootstrap
  namespace: vmware-system-antrea
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      containers:
        - name: bootstrap
          image: vmware.io/antrea/bootstrap:latest
          imagePullPolicy: IfNotPresent
          command:
            - "/usr/local/bin/bootstrap.sh"
          # NOTE: change to actual cluster name, NSX IPs and vpcPath. vpcPath can be empty.
          # Example vpcPath: /orgs/default/projects/project1/vpcs/my-vpc1
          args:
            - "dummyClusterName"
            - "dummyNSXIP1, dummyNSXIP2, dummyNSXIP3"
            - "dummyVPCPath"
          volumeMounts:
            - mountPath: /etc/antrea
              name: nsx
              readOnly: true
      volumes:
        - name: nsx
          secret:
            secretName: nsxsecret
      restartPolicy: OnFailure
      serviceAccountName: bootstrap
      hostNetwork: true
      tolerations:
        - key: CriticalAddonsOnly
          operator: Exists
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
        - effect: NoSchedule
          key: node-role.kubernetes.io/control-plane
  backoffLimit: 3
---
# In development environment the following bootstrap config and secret is
# generated by bootstrap Job.
# In production the bootstrap config and secret should be generated by admin
# manually or external automation mechanism.
apiVersion: v1
kind: ConfigMap
metadata:
 name: bootstrap-config
 namespace: vmware-system-antrea
data:
 bootstrap.conf: |
   clusterName: dummyClusterName
   vpcPath: "" # or "/orgs/default/projects/project1/vpcs/my-vpc1"
   NSXManagers: [dummyNSXIP1, dummyNSXIP2, dummyNSXIP3]
---
apiVersion: v1
kind: Secret
metadata:
 name: nsx-cert
 namespace: vmware-system-antrea
type: kubernetes.io/tls
data:
 tls.crt: # base64 encoded data
 tls.key: # base64 encoded data
